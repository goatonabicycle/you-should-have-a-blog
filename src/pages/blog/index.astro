---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Header from "../../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";

const posts = (await getCollection("blog")).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const postsWithStats = posts.map((post) => {
	const plainText = post.body || "";
	const wordCount = plainText
		.split(/\s+/)
		.filter((word) => word.length > 0).length;
	return { ...post, wordCount };
});
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			.posts-table {
				width: 100%;
				border-spacing: 0;
				border-collapse: separate;
			}
			.posts-table tbody tr {
				border: none;
				transition: all 0.2s ease;
			}
			.posts-table tbody tr:not(:last-child) td {
				border-bottom: 1px solid var(--border);
			}
			.posts-table tbody tr:hover,
			.posts-table tbody tr:focus-within {
				background: rgba(125, 211, 252, 0.05);
			}
			.posts-table td {
				padding: 0.8rem 0;
				border: none;
				vertical-align: baseline;
			}
			.posts-table td:last-child {
				text-align: right;
				white-space: nowrap;
				color: var(--color-dim);
				font-size: 0.85em;
			}
			.posts-table a {
				text-decoration: none;
				color: var(--ink);
				display: block;
				padding: 0.2em 0;
				outline: none;
			}
			.posts-table a::before {
				content: "> ";
				color: var(--color-accent);
				font-weight: 700;
				font-size: 0.9em;
				opacity: 0;
				transition: opacity 0.2s ease;
			}
			.posts-table a:focus::before,
			.posts-table a:hover::before {
				opacity: 1;
			}
			.posts-table a:focus,
			.posts-table a:hover {
				color: var(--color-accent);
			}
			.title {
				font-size: 1em;
				font-weight: 400;
				font-family: inherit;
			}
			.word-count {
				margin-left: 0.5em;
				font-size: 0.7em;
				color: var(--color-dim);
				opacity: 0;
				transition: opacity 0.2s ease;
			}
			.posts-table tr:hover .word-count,
			.posts-table a:focus .word-count {
				opacity: 0.7;
			}
			.post-meta {
				color: var(--color-dim);
				font-size: 0.85em;
				font-family: inherit;
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<h1>Posts</h1>
			<section>
				<table class="posts-table">
					<tbody>
						{
							postsWithStats.map((post) => (
								<tr>
									<td>
										<a href={`/blog/${post.id}/`}>
											<span class="title">{post.data.title}</span>
											<span class="word-count">({post.wordCount} words)</span>
										</a>
									</td>
									<td>
										<div class="post-meta">
											<FormattedDate
												date={post.data.pubDate}
												showDaysAgo={true}
											/>
										</div>
									</td>
								</tr>
							))
						}
					</tbody>
				</table>
			</section>
		</main>
		<Footer />
	</body>
</html>